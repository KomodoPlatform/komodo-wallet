<!DOCTYPE html>
<html style="height: 100%;">

<head>
    <title>Fiat OnRamp</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
        }

        iframe {
            position: relative;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }
    </style>
</head>

<body>
    <iframe id="fiat-onramp-iframe" sandbox="allow-same-origin allow-popups allow-scripts allow-forms" src="">
    </iframe>
    <script>
        // Intercept console.log messages and route them through the onMessageHandler
        // console.log = function (...args) {
        //     onMessageHandler({ data: JSON.stringify(args) });
        // };

        window.onmessage = onMessageHandler;

        function getUrlParameter(name) {
            const params = new URLSearchParams(window.location.search);
            return params.get(name);
        }

        // Get the `url` parameter
        const urlParam = getUrlParameter('fiatUrl');
        let targetUrl = null;

        if (urlParam) {
            try {
                targetUrl = atob(urlParam); // base64 decode the `url` parameter
            } catch (error) {
                console.error('Error decoding base64 url parameter', error);
            }
        }

        if (targetUrl) {
            // Set the iframe's src attribute
            document.getElementById('fiat-onramp-iframe').src = targetUrl;
        } else {
            console.error('No URL parameter provided');
        }

        function onMessageHandler(messageEvent) {
            let messageData;
            try {
                // Try parsing the data as JSON 
                messageData = JSON.parse(messageEvent.data);
            } catch (parseError) {
                // If parsing fails, just use it as a string
                messageData = messageEvent.data;
            }

            try {
                postMessageToParent(messageData);
            } catch (postError) {
                console.error('Error posting message', postError);
            }
        }

        /** 
         * Post a message to the parent window
         * 
         * @param {string|object} messageData 
         */
        function postMessageToParent(messageData) {
            // Convert messageData to a string if it is an object
            const messageString = (typeof messageData === 'object') ? JSON.stringify(messageData) : String(messageData);

            // flutter_inappwebview
            console.log(messageString);

            // universal_url opener 
            if (window.opener) {
                return window.opener.postMessage(messageString, "*");
            }

            if (window.parent && window.parent !== window) {
                return window.parent.postMessage(messageString, "*");
            }

            // Windows WebView2 (desktop_webview_window) - https://learn.microsoft.com/en-us/microsoft-edge/webview2/how-to/communicate-btwn-web-native 
            if (window.chrome && window.chrome.webview) {
                return window.chrome.webview.postMessage(messageString);
            }

            console.error('No valid postMessage target found');
        }
    </script>
</body>

</html>