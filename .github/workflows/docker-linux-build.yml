name: Build Linux Dekstop in Docker
# Note: This workflow almost entirely mirrors the existing Jenkins Pipeline.

on:
  pull_request:
    branches:
      [
        dev,
        main,
        release/*,
        hotfix/*,
        bugfix/*,
        feature/*,
        chore/*,
        build/*,
        ci/*,
      ]
    paths:
      - ".docker/**"
      - "linux/**"
      - "pubspec.yaml"
      - "pubspec.lock"
  workflow_dispatch:

jobs:
  build-linux-docker:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build Linux Desktop
        env:
          GITHUB_API_PUBLIC_READONLY_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Optional feedback provider secrets to embed dart-defines
          TRELLO_API_KEY: ${{ secrets.TRELLO_API_KEY }}
          TRELLO_TOKEN: ${{ secrets.TRELLO_TOKEN }}
          TRELLO_BOARD_ID: ${{ secrets.TRELLO_BOARD_ID }}
          TRELLO_LIST_ID: ${{ secrets.TRELLO_LIST_ID }}
          FEEDBACK_API_KEY: ${{ secrets.FEEDBACK_API_KEY }}
          FEEDBACK_PRODUCTION_URL: ${{ secrets.FEEDBACK_PRODUCTION_URL }}
          MATOMO_URL: ${{ secrets.MATOMO_URL }}
          MATOMO_SITE_ID: ${{ secrets.MATOMO_SITE_ID }}
        run: |
          chmod +x .docker/build.sh
          sh .docker/build.sh linux release

      - name: Compute short commit SHA
        id: vars
        shell: bash
        run: echo "short_sha=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT
  
      - name: Upload Linux bundle artifact
        uses: actions/upload-artifact@v4
        with:
          name: komodo-wallet-linux-docker-${{ steps.vars.outputs.short_sha }}.zip
          path: build/linux/x64/release/bundle/*
          retention-days: 5
